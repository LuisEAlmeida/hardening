<!-- 

### 6.2.2.1.4 Asegurar que el servicio systemd-journal-remote no estÃ© en uso (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
Journal `systemd-journal-remote` admite la capacidad de recibir mensajes de hosts remotos, actuando asÃ­ como un servidor de registros. Los clientes no deberÃ­an recibir datos de otros hosts.

> â„¹ **Nota:**
> - El mismo paquete, `systemd-journal-remote`, se usa tanto para enviar registros a hosts remotos como para recibir registros entrantes.
> - En cuanto a la recepciÃ³n de registros, existen dos servicios: `systemd-journal-remote.socket` y `systemd-journal-remote.service`.

#### JustificaciÃ³n:
Si un cliente estÃ¡ configurado para recibir datos, convirtiÃ©ndose en un servidor, el sistema cliente estÃ¡ operando fuera de su lÃ­mite funcional.

> â„¹ **Nota:** Esta recomendaciÃ³n **solo aplica si journald es el mÃ©todo elegido para el registro del cliente**. No aplique esta recomendaciÃ³n si se utiliza `rsyslog`.

#### AuditorÃ­a:
Ejecute el siguiente comando para verificar que `systemd-journal-remote.socket` y `systemd-journal-remote.service` no estÃ©n habilitados:

```bash
# systemctl is-enabled systemd-journal-remote.socket systemd-journal-remote.service | grep -P -- '^enabled'
```

No se debe devolver nada
Ejecute el siguiente comando para verificar que `systemd-journal-remote.socket` y `systemd-journal-remote.service` no estÃ©n activos:

```bash
# systemctl is-active systemd-journal-remote.socket systemd-journal-remote.service | grep -P -- '^active'
```

No se debe devolver nada

#### ReneduaciÃ³n
Ejecute los siguientes comandos para detener y enmascarar systemd-journal-remote.socket y systemd-journal-remote.service:

```bash
# systemctl stop systemd-journal-remote.socket systemd-journal-remote.service 
# systemctl mask systemd-journal-remote.socket systemd-journal-remote.service
```

#### Referencias: 

1. NIST SP 800-53 Rev. 5: AU-2, AU-7 AU-12

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **4.8 Desinstalar o deshabilitar servicios innecesarios en activos empresariales y software**<br>Desinstale o deshabilite servicios innecesarios en activos empresariales y software, como un mÃ³dulo de uso compartido de archivos no utilizado, un mÃ³dulo de aplicaciÃ³n web o una funciÃ³n de servicio. |  | ğŸŸ  | ğŸ”µ |
| **v7** | **9.2 Asegurar que solo los puertos, protocolos y servicios aprobados estÃ©n en ejecuciÃ³n**<br>AsegÃºrese de que solo los puertos de red, protocolos y servicios necesarios segÃºn los requerimientos comerciales validados estÃ©n en ejecuciÃ³n en cada sistema. |  | ğŸŸ  | ğŸ”µ |

---

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1562, T1562.006 | TA0040 | M1029 | -->


### 6.2.2.2 Asegurar que ForwardToSyslog de journald estÃ© deshabilitado (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
Los datos de **journald** deben permanecer dentro del servicio y no ser reenviados a otros servicios.

#### JustificaciÃ³n:
- **SI** **journald** es el mÃ©todo para capturar registros, todos los registros del sistema deben ser manejados por **journald** y no ser reenviados a otros mecanismos de registro.

> â„¹ **Nota:** Esta recomendaciÃ³n **solo aplica si journald es el mÃ©todo elegido para el registro del cliente**. No aplique esta recomendaciÃ³n si se utiliza **rsyslog**.

#### AuditorÃ­a:
- **SI** **journald** es el mÃ©todo para capturar registros  
Ejecute el siguiente comando para verificar que **ForwardToSyslog** estÃ© configurado en **no**:

```bash
# systemd-analyze cat-config systemd/journald.conf systemd/journald.conf.d/*
| grep -E "^ForwardToSyslog=no"
ForwardToSyslog=no
```

#### RemediaciÃ³n:

- **SI** `rsyslog` es el mÃ©todo preferido para capturar registros, esta secciÃ³n y la recomendaciÃ³n deben omitirse, y se debe seguir la secciÃ³n "Configurar rsyslog".

- **SI** `journald` es el mÃ©todo preferido para capturar registros:

  Establezca el siguiente parÃ¡metro en la secciÃ³n **[Journal]** en `/etc/systemd/journald.conf` o en un archivo dentro de `/etc/systemd/journald.conf.d/` que termine en `.conf`:

```bash
ForwardToSyslog=no
```
ejemplos

```bash
#!/usr/bin/env bash

{
    [ ! -d /etc/systemd/journald.conf.d/ ] && mkdir /etc/systemd/journald.conf.d/

    if grep -Psq -- '^\h*\t*\[Journal\]' /etc/systemd/journald.conf.d/60-journald.conf; then
        printf '%s\n' "ForwardToSyslog=no" >> /etc/systemd/journald.conf.d/60-journald.conf
    else
        printf '%s\n' "[Journal]" "ForwardToSyslog=no" >> /etc/systemd/journald.conf.d/60-journald.conf
    fi
}
```

> â„¹ **Nota:**
> Si esta configuraciÃ³n aparece en un archivo canÃ³nicamente posterior o mÃ¡s adelante en el mismo archivo, la configuraciÃ³n serÃ¡ sobrescrita.

Ejecute el siguiente comando para actualizar los parÃ¡metros en el servicio:

```bash
# systemctl reload-or-restart systemd-journald
```
Valor por defecto:
ForwardToSyslog=no

#### Referencias:
1. NIST SP 800-53 Rev. 5: AU-2, AU-6, AU-7, AU-12

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |

---

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1562, T1562.006 | TA0040 | M1029 |
--- -->

### 6.2.2.3 Asegurar que journald Compress estÃ© configurado (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
El sistema **journald** incluye la capacidad de comprimir archivos excesivamente grandes para evitar que el sistema se llene con registros o que los registros sean incontrolablemente grandes.

#### JustificaciÃ³n:
Los archivos grandes sin comprimir pueden llenar inesperadamente un sistema de archivos, lo que lleva a la indisponibilidad de recursos. Comprimir los registros antes de escribirlos puede prevenir impactos repentinos e inesperados en el sistema de archivos.

> â„¹ **Nota:** Esta recomendaciÃ³n **solo aplica si journald es el mÃ©todo elegido para el registro del cliente**. No aplique esta recomendaciÃ³n si se utiliza **rsyslog**.

#### AuditorÃ­a:
Ejecute el siguiente comando para verificar que **Compress** estÃ© configurado en **yes**:

```bash
# systemd-analyze cat-config systemd/journald.conf systemd/journald.conf.d/* \
| grep -E "^Compress=yes"

Compress=yes
```
#### RemediaciÃ³n:

Establezca el siguiente parÃ¡metro en la secciÃ³n `[Journal]` en `/etc/systemd/journald.conf` o en un archivo dentro de `/etc/systemd/journald.conf.d/` que termine en `.conf`:

#### Ejemplo:

```bash
#!/usr/bin/env bash

{
    [ ! -d /etc/systemd/journald.conf.d/ ] && mkdir /etc/systemd/journald.conf.d/

    if grep -Psq -- '^\h*\t*\[Journal\]' /etc/systemd/journald.conf.d/60-journald.conf; then
        printf '%s\n' "Compress=yes" >> /etc/systemd/journald.conf.d/60-journald.conf
    else
        printf '%s\n' "[Journal]" "Compress=yes" >> /etc/systemd/journald.conf.d/60-journald.conf
    fi
}
```

> â„¹ **Nota:**
Si esta configuraciÃ³n aparece en un archivo canÃ³nicamente posterior o mÃ¡s adelante en el mismo archivo, la configuraciÃ³n serÃ¡ sobrescrita.

Ejecute el siguiente comando para actualizar los parÃ¡metros en el servicio:

```bash
# systemctl reload-or-restart systemd-journald
```

#### Referencias
1. NIST SP 800-53 Rev. 5: AU-4

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v8** | **8.3 Asegurar un almacenamiento adecuado para los registros de auditorÃ­a**<br>AsegÃºrese de que los destinos de registro mantengan un almacenamiento adecuado para cumplir con el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 Activar el registro de auditorÃ­a**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |
| **v7** | **6.4 Asegurar un almacenamiento adecuado para los registros**<br>AsegÃºrese de que todos los sistemas que almacenan registros tengan suficiente espacio de almacenamiento para los registros generados. |  | ğŸŸ  | ğŸ”µ | -->

---

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1562, T1562.001 | TA0040 | M1053 |

### 6.2.2.4 Asegurar que journald Storage estÃ© configurado (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
Los datos de **journald** pueden almacenarse en memoria volÃ¡til o persistirse localmente en el servidor.  
Los registros en memoria se perderÃ¡n tras un reinicio del sistema.  
Al persistir los registros en el disco local del servidor, estÃ¡n protegidos contra la pÃ©rdida de datos debido a un reinicio.

#### JustificaciÃ³n:
Escribir los datos de registro en el disco permite la capacidad de reconstrucciÃ³n forense de eventos  
que pudieron haber afectado las operaciones o la seguridad de un sistema, incluso despuÃ©s de un fallo o reinicio.

> â„¹ **Nota:** Esta recomendaciÃ³n **solo aplica si `journald` es el mÃ©todo elegido para el registro del cliente**. No aplique esta recomendaciÃ³n si se utiliza `rsyslog`.

#### AuditorÃ­a:
Ejecute el siguiente comando para verificar que `Storage` estÃ© configurado en `persistent`:

```bash
# systemd-analyze cat-config systemd/journald.conf systemd/journald.conf.d/* \
| grep -E "^Storage=persistent"

Storage=persistent
```

#### RemediaciÃ³n:

Establezca el siguiente parÃ¡metro en la secciÃ³n `[Journal]` en `/etc/systemd/journald.conf` o en un archivo dentro de `/etc/systemd/journald.conf.d/` que termine en `.conf`:

#### Ejemplo:

```bash
#!/usr/bin/env bash

{
    [ ! -d /etc/systemd/journald.conf.d/ ] && mkdir /etc/systemd/journald.conf.d/

    if grep -Psq -- '^\h*\t*\[Journal\]' /etc/systemd/journald.conf.d/60-journald.conf; then
        printf '%s\n' "Storage=persistent" >> /etc/systemd/journald.conf.d/60-journald.conf
    else
        printf '%s\n' "[Journal]" "Storage=persistent" >> /etc/systemd/journald.conf.d/60-journald.conf
    fi
}
```

> â„¹ **Nota:**
Si esta configuraciÃ³n aparece en un archivo canÃ³nicamente posterior o mÃ¡s adelante en el mismo archivo, la configuraciÃ³n serÃ¡ sobrescrita.

Ejecute el siguiente comando para actualizar los parÃ¡metros en el servicio:

```bash
# systemctl reload-or-restart systemd-journald
```

#### Referencia

1. NIST SP 800-53 Rev. 5: AU-3, AU-12

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 Activar el registro de auditorÃ­a**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |

--- -->

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1562, T1562.006 | TA0005 | M1022 |

## 6.2.3 Configurar rsyslog

El paquete de software `rsyslog` puede utilizarse en lugar del mecanismo de registro predeterminado `journald`.

Rsyslog ha evolucionado a lo largo de varias dÃ©cadas. Por esta razÃ³n, admite tres formatos de configuraciÃ³n diferentes ("lenguajes"):

- **`bÃ¡sico`** - anteriormente conocido como el formato `sysklogd`, este es el formato mejor utilizado para expresar configuraciones simples, como la ubicaciÃ³n de una declaraciÃ³n en una sola lÃ­nea.
  - Se remonta al formato original `syslog.conf`, que ha estado en uso durante varias dÃ©cadas.
  - El caso de uso mÃ¡s comÃºn es la coincidencia basada en facilidad/gravedad y la escritura de mensajes coincidentes en un archivo de registro.

- **`avanzado`** - anteriormente conocido como el formato `RainerScript`, este formato estuvo disponible por primera vez en rsyslog v6 y es el formato mÃ¡s preciso y moderno para casos de uso no triviales donde se necesita mÃ¡s de una lÃ­nea.
  - Antes de la versiÃ³n 7, habÃ­a un impacto en el rendimiento al usar este formato, lo que alentaba el uso del formato bÃ¡sico para obtener mejores resultados. Las versiones actuales de rsyslog no sufren este impacto de rendimiento (histÃ³rico).
  - Este nuevo formato estÃ¡ especÃ­ficamente dirigido a casos de uso mÃ¡s avanzados, como el reenvÃ­o de registros a hosts remotos que podrÃ­an estar disponibles solo parcialmente.

- **`obsoleto (legado)`** - anteriormente conocido simplemente como el formato `legacy`, este formato es exactamente lo que su nombre indica: obsoleto y no deberÃ­a usarse al escribir nuevas configuraciones. Fue creado en los primeros dÃ­as (hasta rsyslog versiÃ³n 5), cuando se esperaba que rsyslog extendiera **sysklogd** solo ligeramente. En consecuencia, su propÃ³sito principal era realizar pequeÃ±os ajustes al formato original **sysklogd**.
  - La prÃ¡ctica ha demostrado que era notoriamente difÃ­cil de usar para casos de uso mÃ¡s avanzados, por lo que fue reemplazado por el formato avanzado.
  - En esencia, cualquier configuraciÃ³n escrita en una sola lÃ­nea que comience con un signo de dÃ³lar (`$`) es un formato legado. Los usuarios de este formato deben **migrar a los formatos bÃ¡sico o avanzado**.

> â„¹ **Nota:**:
Esta secciÃ³n **solo aplica si `rsyslog` es el mÃ©todo elegido para el registro del cliente**. No aplique esta secciÃ³n si se utiliza `journald`.

### 6.2.3.1 Asegurar que rsyslog estÃ© instalado (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
El software **rsyslog** se recomienda en entornos donde **journald** no cumple con los requisitos operativos.

#### JustificaciÃ³n:
Las mejoras de seguridad de **rsyslog**, como la transmisiÃ³n de registros orientada a conexiÃ³n (por ejemplo, TCP),  
la opciÃ³n de registrar datos en formatos de bases de datos y el cifrado de los registros en trÃ¡nsito hacia un servidor central de registros,  
justifican la instalaciÃ³n y configuraciÃ³n de este paquete.

> â„¹ **Nota:**: Esta recomendaciÃ³n **solo aplica si rsyslog es el mÃ©todo elegido para el registro del cliente**.  
> No aplique esta recomendaciÃ³n si se utiliza **journald**.

#### AuditorÃ­a:
- **SI** **rsyslog** se usa para el registro en el sistema:  
Ejecute el siguiente comando para verificar que **rsyslog** estÃ¡ instalado:

```bash
# rpm -q rsyslog
```

Verifique que la salida coincida:

```bash
rsyslog-<version>
```

#### RecomendaciÃ³n:
Ejecute el siguiente comando para instalar rsyslog:

```bash
# dnf install rsyslog
```

#### Valor predeterminado:
Instalado
#### Referencias:
1. NIST SP 800-53 Rev. 5: AU-2, AU-3, AU-12

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 Activar el registro de auditorÃ­a**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |

--- -->

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1005, T1005.000, T1070, T1070.002 | TA0005 | M1029, M1057 |

### 6.2.3.2 Asegurar que el servicio rsyslog estÃ© habilitado y activo (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
Una vez que el paquete **`rsyslog`** estÃ© instalado, asegÃºrese de que el servicio estÃ© habilitado.

#### JustificaciÃ³n:
Si el servicio **`rsyslog`** no estÃ¡ habilitado para iniciarse en el arranque, el sistema no capturarÃ¡ eventos de registro.

> â„¹ **Nota:**: Esta recomendaciÃ³n **solo aplica si rsyslog es el mÃ©todo elegido para el registro del cliente**.  
No aplique esta recomendaciÃ³n si se utiliza **`journald`**.

#### AuditorÃ­a:
- **SI** **`rsyslog`** se usa para el registro en el sistema:  
Ejecute el siguiente comando para verificar que **`rsyslog.service`** estÃ¡ habilitado:

```bash
# systemctl is-enabled rsyslog
enabled
```

Ejecute el siguiente comando para verificar que `rsyslog.service` estÃ¡ activo:

```bash
# systemctl is-active rsyslog.service
active
```

#### RemediaciÃ³n:
**SI rsyslog** se usa para el registro en el sistema:
Ejecute los siguientes comandos para desmascarar, habilitar e iniciar `rsyslog.service`:

```bash
# systemctl unmask rsyslog.service
# systemctl enable rsyslog.service
# systemctl start rsyslog.service
```

#### Referencias:
NIST SP 800-53 Rev. 5: AU-2, AU-3, AU-12

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 Activar el registro de auditorÃ­a**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |

--- -->

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1211, T1562, T1562.001 | TA0005 | M1029 |


### 6.2.3.3 Asegurar que journald estÃ© configurado para enviar registros a rsyslog (Automatizado)

#### Aplicabilidad del perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
Los datos de **systemd-journald** pueden almacenarse en memoria volÃ¡til o persistirse localmente en el servidor.  
Existen utilidades para aceptar la exportaciÃ³n remota de registros de **systemd-journald**, sin embargo,  
el uso del servicio **rsyslog** proporciona un medio consistente para la recopilaciÃ³n y exportaciÃ³n de registros.

#### JustificaciÃ³n:
- **SI** **rsyslog** es el mÃ©todo preferido para capturar registros, todos los registros del sistema deben enviarse a Ã©l para su procesamiento adicional.

#### Impacto:
- **SI** **journald** es el mÃ©todo preferido para capturar registros, esta secciÃ³n y su recomendaciÃ³n deben omitirse,  
  y en su lugar, debe seguirse la secciÃ³n **"Configurar Journald"**.

#### AuditorÃ­a:
- **SI** **rsyslog** es el mÃ©todo preferido para capturar registros:  
Ejecute el siguiente comando para verificar que los registros se estÃ¡n reenviando a **rsyslog**,  
configurando **ForwardToSyslog** en **yes** en la configuraciÃ³n de **systemd-journald**:

```bash
# systemd-analyze cat-config systemd/journald.conf systemd/journald.conf.d/* \
  | grep -E "^ForwardToSyslog=yes"

ForwardToSyslog=yes
```

#### RemediaciÃ³n:

- **SI** **`rsyslog`** es el mÃ©todo preferido para capturar registros:  
  Establezca el siguiente parÃ¡metro en la secciÃ³n **`[Journal]`** dentro de  
  `/etc/systemd/journald.conf` o en un archivo dentro de `/etc/systemd/journald.conf.d/`  
  que termine en `.conf`:

```bash
ForwardToSyslog=yes
```
#### Ejemplo

```bash
#!/usr/bin/env bash

{
    [ ! -d /etc/systemd/journald.conf.d/ ] && mkdir /etc/systemd/journald.conf.d/

    if grep -Psq -- '^\h*\t*\[Journal\]' /etc/systemd/journald.conf.d/60-journald.conf; then
        printf '%s\n' "ForwardToSyslog=yes" >> /etc/systemd/journald.conf.d/60-journald.conf
    else
        printf '%s\n' "[Journal]" "ForwardToSyslog=yes" >> /etc/systemd/journald.conf.d/60-journald.conf
    fi
}
```

> â„¹ **Nota:**:
> Si esta configuraciÃ³n aparece en un archivo posterior canÃ³nicamente o mÃ¡s adelante en el mismo archivo,  
la configuraciÃ³n serÃ¡ sobrescrita.

Ejecute el siguiente comando para actualizar los parÃ¡metros en el servicio:  
Reinicie **systemd-journald.service**:

```bash
# systemctl reload-or-restart systemd-journald.service
```

#### Referencia

1. NIST SP 800-53 Rev. 5: AC-3, AU-2, AU-4, AU-12, MP-2
2. SYSTEMD-JOURNALD.SERVICE(8)
3. JOURNALD.CONF(5)

## InformaciÃ³n adicional:

Como se menciona en las pÃ¡ginas del manual de **systemd-journald**, los registros de **systemd-journald** pueden exportarse a **rsyslog** ya sea a travÃ©s del proceso mencionado aquÃ­ o mediante una facilidad como **systemd-journal.service**. Existen compensaciones en cada implementaciÃ³n:  
- **ForwardToSyslog** capturarÃ¡ inmediatamente todos los eventos  
  (y los reenviarÃ¡ a un servidor de registros externo si estÃ¡ configurado correctamente),  
  pero **puede no capturar todas las actividades de arranque**.  

- Mecanismos como **systemd-journal.service**, en cambio,  
  registrarÃ¡n los eventos de arranque, pero pueden retrasar el envÃ­o de la informaciÃ³n a **rsyslog**,  
  lo que conlleva el **riesgo de manipulaciÃ³n de registros antes de su exportaciÃ³n**.  

**Es importante conocer las limitaciones de todas las herramientas empleadas para asegurar un sistema.**

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 Recopilar registros de auditorÃ­a**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v8** | **8.9 Centralizar registros de auditorÃ­a**<br>Centralice, en la medida de lo posible, la recopilaciÃ³n y retenciÃ³n de registros de auditorÃ­a en toda la empresa. |  | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 Activar el registro de auditorÃ­a**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 Habilitar el registro detallado**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada, como la fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |
| **v7** | **6.5 GestiÃ³n centralizada de registros**<br>AsegÃºrese de que los registros adecuados se estÃ©n agregando a un sistema central de gestiÃ³n de registros para anÃ¡lisis y revisiÃ³n. |  | ğŸŸ  | ğŸ”µ |

--- -->

## Mapeo de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1562, T1562.006, T1565 | TA0040 | M1029 |

### 6.2.3.4 Asegurar que el modo de creaciÃ³n de archivos de registro de rsyslog estÃ© configurado (Automatizado)

#### Aplicabilidad del Perfil:
- Nivel 1 - Servidor
- Nivel 1 - EstaciÃ³n de trabajo

#### DescripciÃ³n:
**`rsyslog`** crearÃ¡ archivos de registro que no existen en el sistema.

El parÃ¡metro **`$FileCreateMode`** permite especificar el modo de creaciÃ³n con el cual **`rsyslog`** crea nuevos archivos.  
Si no se especifica, se usa el valor `0644` (que mantiene compatibilidad con versiones anteriores).  
El valor siempre debe ser un nÃºmero octal de 4 dÃ­gitos, donde el primer dÃ­gito debe ser cero.

Tenga en cuenta que los permisos reales dependen de la umask del proceso de **`rsyslog`**.

**`$FileCreateMode`** puede especificarse varias veces. Si es asÃ­, define el modo de creaciÃ³n  
para todos los selectores de registros que sigan hasta el prÃ³ximo parÃ¡metro **`$FileCreateMode`**.  
El orden de las lÃ­neas es vitalmente importante.

#### JustificaciÃ³n:
Es importante asegurarse de que los archivos de registro tengan los permisos correctos  
para garantizar que los datos sensibles sean archivados y protegidos.

> â„¹ **Nota:**:
> Esta recomendaciÃ³n **solo aplica si rsyslog es el mÃ©todo elegido para el registro de logs**.  
No aplique esta recomendaciÃ³n si **`systemd-journald`** estÃ¡ en uso.

---

#### AuditorÃ­a:
Ejecute el siguiente comando para verificar **`$FileCreateMode`**:

```bash
# grep -Ps '^\h*\$FileCreateMode\h+[0,2,4,6][0,2,4,6][0,2,4,6][0,2,4,6]\b' /etc/rsyslog.conf /etc/rsyslog.d/*.conf
```
Verifique que la salida incluya 0640 o mÃ¡s restrictivos:

```bash
$FileCreateMode 0640
```

Si una polÃ­tica del sitio dicta permisos menos restrictivos, asegÃºrese de cumplir dicha polÃ­tica. 

> â„¹ **Nota:**: Los permisos mÃ¡s restrictivos, como 0600, son implÃ­citamente suficientes.

## RemediaciÃ³n:

Edite el archivo **/etc/rsyslog.conf** o un archivo **.conf** dedicado en **/etc/rsyslog.d/**  
y configure **$FileCreateMode** a **0640** o un valor mÃ¡s restrictivo:

```bash
$FileCreateMode 0640
```

Reiniciar el servicio:

```bash
# systemctl restart rsyslog
```

#### Referencias:

1. RSYSLOG.CONF(5)
2. NIST SP 800-53 Rev. 5: AC-3, AC-6, MP-2
3. [DocumentaciÃ³n de Rsyslog](https://www.rsyslog.com/doc/)
4. [ConfiguraciÃ³n de $FileCreateMode en Rsyslog](https://www.rsyslog.com/doc/configuration/action/rsconf1_filecreatemode.html#filecreatemode)

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| v8  | **3.3 Configurar listas de control de acceso a datos**<br>Configurar listas de control de acceso basadas en la necesidad del usuario. Aplicar listas de control de acceso, como permisos de acceso a archivos locales y remotos, bases de datos y aplicaciones. | ğŸŸ¢ | ğŸ”µ | ğŸŸ  |
| v8  | **8.2 Recopilar registros de auditorÃ­a**<br>Recopilar registros de auditorÃ­a. Asegurar que la gestiÃ³n de registros de auditorÃ­a, segÃºn el proceso de gestiÃ³n de registros de la empresa, estÃ© habilitada en todos los activos empresariales. | ğŸŸ¢ | ğŸ”µ | ğŸŸ  |
| v7  | **5.1 Establecer configuraciones seguras**<br>Mantener estÃ¡ndares documentados y estÃ¡ndar de configuraciÃ³n de seguridad para todos los sistemas operativos y software autorizados. | ğŸŸ¢ | ğŸ”µ | ğŸŸ  |
| v7  | **6.2 Activar el registro de auditorÃ­a**<br>Asegurar que el registro local estÃ© habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸ”µ | ğŸŸ  |
| v7  | **6.3 Habilitar el registro detallado**<br>Habilitar el registro del sistema para incluir informaciÃ³n detallada como fuente del evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸ”µ | ğŸŸ  | -->

## Mapeo MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002, T1083, T1083.000 | TA0007 | M1022 |

### 6.2.3.5 Asegurar que rsyslog estÃ© configurado (Manual)

#### Aplicabilidad del Perfil:
- **Nivel 1 - Servidor**
- **Nivel 1 - EstaciÃ³n de trabajo**

#### DescripciÃ³n:
Los archivos `/etc/rsyslog.conf` y `/etc/rsyslog.d/*.conf` especifican reglas para el registro de eventos y quÃ© archivos se utilizarÃ¡n para registrar ciertas clases de mensajes.

#### JustificaciÃ³n:
Mucha informaciÃ³n crÃ­tica relacionada con la seguridad se envÃ­a a travÃ©s de **rsyslog** 
(por ejemplo, intentos de `su` exitosos y fallidos, intentos de inicio de sesiÃ³n fallidos, intentos de inicio de sesiÃ³n como root, etc.).

> â„¹ **Nota:**: Esta recomendaciÃ³n solo aplica si **rsyslog** es el mÃ©todo elegido para el registro del lado del cliente.  
No aplicar esta recomendaciÃ³n si **journald** estÃ¡ en uso.

#### AuditorÃ­a:
1. Revisar el contenido de los archivos de configuraciÃ³n:
   ```bash
   cat /etc/rsyslog.conf
   cat /etc/rsyslog.d/*.conf
   ```

#### RemediaciÃ³n:

### EdiciÃ³n de archivos de configuraciÃ³n
Edite las siguientes lÃ­neas en los archivos:
- `/etc/rsyslog.conf`
- `/etc/rsyslog.d/*.conf`

segÃºn corresponda a su entorno.

> â„¹ **Nota:**: La configuraciÃ³n a continuaciÃ³n se proporciona solo con fines ilustrativos. Se debe considerar cuidadosamente cÃ³mo la organizaciÃ³n desea almacenar los datos de registro.

### Ejemplo de configuraciÃ³n:

```plaintext
*.emerg                         :omusrmsg:*
auth,authpriv.*                  /var/log/secure
mail.*                           -/var/log/mail
mail.info                        -/var/log/mail.info
mail.warning                     -/var/log/mail.warn
mail.err                         -/var/log/mail.err
cron.*                           /var/log/cron
*.warning;*.=err                 -/var/log/warn
*.crit                           -/var/log/warn
*.*;mail.none;news.none          -/var/log/messages
local0,local1.*                  -/var/log/localmessages
local2,local3.*                  -/var/log/localmessages
local4,local5.*                  -/var/log/localmessages
local6,local7.*                  -/var/log/localmessages
```

Ejecute el siguiente comando para recargar la configuraciÃ³n de `rsyslogd`:

```bash
# systemctl restart rsyslog
```

#### Referencias:
1. Consulte la pÃ¡gina de manual `rsyslog.conf(5)` para obtener mÃ¡s informaciÃ³n.
2. NIST SP 800-53 Rev. 5: AU-2, AU-7, AU-12

---

## Controles CIS:

<!-- | VersiÃ³n de Controles | Control | IG 1 | IG 2 | IG 3 |
|----------------------|---------|------|------|------|
| **v8** | **8.2 [Recopilar registros de auditorÃ­a](#recopilar-registros-de-auditorÃ­a)**<br>Recopile registros de auditorÃ­a. AsegÃºrese de que el registro, segÃºn el proceso de gestiÃ³n de registros de auditorÃ­a de la empresa, se haya habilitado en todos los activos empresariales. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.2 [Activar el registro de auditorÃ­a](#activar-el-registro-de-auditorÃ­a)**<br>AsegÃºrese de que el registro local se haya habilitado en todos los sistemas y dispositivos de red. | ğŸŸ¢ | ğŸŸ  | ğŸ”µ |
| **v7** | **6.3 [Habilitar el registro detallado](#habilitar-el-registro-detallado)**<br>Habilite el registro del sistema para incluir informaciÃ³n detallada como una fuente de evento, fecha, usuario, marca de tiempo, direcciones de origen, direcciones de destino y otros elementos Ãºtiles. |  | ğŸŸ  | ğŸ”µ |

--- -->

## Mapeos de MITRE ATT&CK:

| TÃ©cnicas / SubtÃ©cnicas | TÃ¡cticas | Mitigaciones |
|------------------------|---------|-------------|
| T1070, T1070.002 | TA0005 | M1047 |

---

### 6.2.3.6 Asegurar que rsyslog estÃ© configurado para enviar registros a un host de registro remoto (Manual)

#### Aplicabilidad del Perfil:
- **Nivel 1 - Servidor**
- **Nivel 1 - EstaciÃ³n de trabajo**

---

#### DescripciÃ³n:
`rsyslog` admite la capacidad de enviar eventos de registro que recopila a un host de registro remoto o recibir mensajes de hosts remotos, lo que permite la gestiÃ³n centralizada de registros.

---

#### JustificaciÃ³n:
Almacenar datos de registro en un host remoto protege la integridad de los registros frente a ataques locales. Si un atacante obtiene acceso root en el sistema local, podrÃ­a manipular o eliminar los datos de registro almacenados en el sistema local.

---

> â„¹ **Nota:** Esta recomendaciÃ³n solo se aplica si `rsyslog` es el mÃ©todo elegido para el registro del lado del cliente. No aplique esta recomendaciÃ³n si se usa `systemd-journald`.

---

#### AuditorÃ­a:

Revisar los archivos `/etc/rsyslog.conf` y `/etc/rsyslog.d/*.conf` y verificar que los registros se envÃ­en a un host central:

> â„¹ **Nota:**: El **formato bÃ¡sico** estÃ¡ destinado a usuarios que configuraron su archivo utilizando `@loghost.example.com`.  
El **formato avanzado** es un formato mÃ¡s moderno que auditarÃ¡ el formato de manera similar a la utilizada en la remediaciÃ³n.

#### Formato bÃ¡sico:
```sh
grep "^*.*[^1][^I]*@" /etc/rsyslog.conf /etc/rsyslog.d/*.conf
```
La salida debe incluir `@@<FQDN o IP del loghost remoto>`:

**Ejemplo:**
```sh
*.* @@loghost.example.com
```

#### formato avanzado
```sh
# grep -Psi -- '^\s*([^#]+\s+)?action\(([^#]+\s+)?\btarget=\"?[^#"]+\"?\b' /etc/rsyslog.conf /etc/rsyslog.d/*.conf
```

La salida debe incluir `target=<FQDN or IP of remote loghost>`:

#### Ejemplo:

```sh
*.* action(type="omfwd" target="loghost.example.com" port="514" protocol="tcp"
```

#### RemediaciÃ³n:
Edite los archivos `/etc/rsyslog.conf` y `/etc/rsyslog.d/*.conf` y agregue la siguiente lÃ­nea (donde loghost.example.com es el nombre de su host de registro central). El `target` de destino puede ser un nombre de dominio completo o una direcciÃ³n IP. 

#### Ejemplo:

 -->
